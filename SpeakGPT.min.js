!function(){window.__myBookmarkletObserver&&(window.__myBookmarkletObserver.disconnect(),console.log("Deactivating prior instance of the bookmarklet"));var r=".prose > *",l=[],s=!1,t=document.querySelector(r),n=document.querySelectorAll(r).length,i=null;let v="",a=null;function f(e){v+=" "+e;var o=window.speechSynthesis,t=(o.cancel(),console.log("Stopping any ongoing speech instances"),new SpeechSynthesisUtterance(e));t.rate=1.1,t.voice=(()=>{var o,e=window.speechSynthesis.getVoices();for(o of["Google UK English Female","Google UK English Male","Fiona","Moira","Alex","Daniel","Melina","Tessa","Karen","Rocko","Ralph","Moira","Organ","Cellos","Jester","Bells","Trinoids","Google US English","en-US"]){var t=e.find(e=>e.lang.match(/^en/)&&e.name===o);if(t)return console.log("Chose Voice: "+o),t}return e[0]})(),console.log("Starting to speak:",e),o.cancel(),clearInterval(a),o.speak(t),a=setInterval(()=>{console.log(o.speaking),o.speaking?(console.log("Resuming Speech..."),o.pause(),o.resume()):clearInterval(a)},14e3)}var c=()=>{if(console.log(),!s&&0!==l.length){s=!0;var o,{text:t,element:n,version:r}=l[0];let e=!1;n.parentElement||(e=!0,console.log("[Skipping]: Weirdo, no parent element"+n.innerText)),e?(s=!1,l.shift(),c()):n.__version!==r?(console.log("Older version: "+r+", final one is: "+n.__version),l.shift(),s=!1,c()):(!n.__shortWaited||n.__shortWaited<3)&&t.length<30?(console.log("Too Short, wait a second... ["+t+"]"),console.log(n),console.log(n.parentElement),n.__shortWaited=n.__shortWaited?n.__shortWaited+1:1,setTimeout(()=>{console.log("Now, Keep Speaking..."),s=!1,c()},1e3)):function(e){var n=/(\b\w+\b)\W*$/,o=/^\W*(\b\w+\b)/,t=v.match(n),r=t?t[1].toLowerCase():null;if(!r||-1===e.indexOf(r))return console.log(`Speaking ALL text (first time, or last spoken word [${r}] is not in text): `+e),f(e),!0;var l,s=[],i=[r];let a=v.slice(0,v.length-t[0].length),c=!1,d=e;for(;null!==(l=o.exec(d));){var h=l[1].toLowerCase();if(s.push(h),d=d.slice(l[0].length+1),h==r){let t=!1;var p=[...i];for(let o=0;a.match(/\w/)&&o<s.length;o++){let e=p.shift();if(void 0===e){var u=a.match(n),g=u?u[1].toLowerCase():null;if(!g)break;i.push(g),e=g,a=a.slice(0,a.length-u[0].length)}if(e!=s[s.length-1-o]){t=!0;break}}if(!t){c=!0;break}}}return c?!!d.match(/\w/)&&(console.log("Speaking Partial text: "+d),f(d),!0):(console.log("Speaking ALL text: "+e),f(e),!0)}(t)?(o=()=>{window.speechSynthesis.speaking||window.speechSynthesis.pending?(console.log("Waiting for Speech to end..."),setTimeout(o,1e3)):(console.log("Done Speaking: "+l.length+" items left in queue"),s=!1,l.shift(),n.__read=!0,c())},setTimeout(o,100)):(console.log("[SKIPPING ]Non-Repeat filter says this has already been completely been said: "+t),s=!1,l.shift(),n.__read=!0,c())}},d=(e,o,t)=>{o.__read||(l.push({text:e,element:o,version:t}),c())},h=e=>{var o,t,n;e.closest(".prose")&&(o=_(e=e),t=void 0===e.__version?0:e.__version,e.__version=t+1,d(o,e,t+1),n=e,new MutationObserver(e=>{p()||e.forEach(e=>{"childList"===e.type&&0<e.addedNodes.length&&e.addedNodes.forEach(e=>{e.nodeType===Node.TEXT_NODE?u(n):e.nodeType===Node.ELEMENT_NODE&&(e.matches(r)?[e]:e.querySelectorAll(r)).forEach(e=>{h(e)})}),"characterData"===e.type&&u(n)})}).observe(n,{childList:!0,subtree:!0,characterData:!0}))},p=()=>{if(null!==i&&i>Date.now())return!0;i=null;var e=document.querySelector(r),o=document.querySelectorAll(r).length;return e!==t&&(o<n||0==o||2<o)&&(console.log("Conversation has changed, resetting"),t=e,n=o,s=!(l=[]),window.speechSynthesis.cancel(),i=Date.now()+2e3,!0)},u=e=>{console.log("Changed element detected:",e);var o=_(e),t=void 0===e.__version?0:e.__version;e.__version=t+1,e.__read=!1,d(o,e,t+1)},e=new MutationObserver(e=>{p()||e.forEach(e=>{"childList"===e.type&&0<e.addedNodes.length&&e.addedNodes.forEach(e=>{e.nodeType===Node.ELEMENT_NODE&&(e.matches(r)?[e]:e.querySelectorAll(r)).forEach(e=>{h(e)})})})});function g(){window.speechSynthesis.cancel(),l=[]}function _(e){var o=e.innerText;return o="pre"===e.tagName.toLowerCase()?"skip, code block here.":o}function m(){g();var e=Array.from(document.querySelectorAll(".prose")).pop();e?Array.from(e.querySelectorAll("*")).forEach((e,o)=>{var t=_(e),n=void 0===e.__version?0:e.__version;e.__version=n+1,v="",d(t,e,n+1)}):console.log("No previous response found")}function y(e,o,t){var n=document.createElement("button");return n.textContent=e,n.style.color=o,n.style.position="fixed",n.style.right="10px",n.style.top="50%",n.style.zIndex=1e3,n.style.backgroundColor="#fff",n.style.border="1px solid #000",n.style.borderRadius="4px",n.style.padding="4px 8px",n.style.fontSize="14px",n.style.cursor="pointer",n.addEventListener("click",t),n}e.observe(document.body,{childList:!0,subtree:!0}),window.currentButtons&&window.currentButtons.forEach(e=>{e&&e.parentNode&&e.parentNode.removeChild(e)}),window.currentButtons=function(){const o=y("Stop","red",g),t=y("Repeat","blue",m);return document.body.appendChild(o),document.body.appendChild(t),setTimeout(()=>{var e=o.parentElement.offsetHeight,e=parseFloat(o.style.top)/100*e;t.style.top=50+e+"px"},500),[o,t]}(),setTimeout(()=>{f("Speak GPT now enabled")},500),window.__myBookmarkletObserver=e}();